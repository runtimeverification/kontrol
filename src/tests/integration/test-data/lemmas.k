requires "../contracts.k"

module SUM-TO-N-INVARIANT

  imports S2KtestZModLoopsTest-CONTRACT

  rule N xorInt maxUInt256 => maxUInt256 -Int N 
  requires #rangeUInt(256, N)
  [simplification]

  rule [foundry-sum-to-n-loop-invariant]:
  <kevm>
    <k>
      ((JUMPI 2423 CONDITION) => JUMP 2423)
      ~> #pc [ JUMPI ]
      ~> #execute
      ...
    </k>
    <mode>
      NORMAL
    </mode>
    <schedule>
      SHANGHAI
    </schedule>
    <ethereum>
      <evm>
        <callState>
          <program>
            PROGRAM
          </program>
          <jumpDests>
            JUMPDESTS
          </jumpDests>
          <wordStack>
              (S => (S +Int ((N *Int (N +Int 1)) /Int 2)))
            : 0 
            : (N => 0)
            : 459 
            : 2123244496 
            : .WordStack
          </wordStack>
          <pc>
            2393
          </pc>
          <gas>
            GAS_AMT:Int => GAS_AMT -Int (N *Int 178)
          </gas>
          ...
        </callState>
        ...
      </evm>
      ...
    </ethereum>
    ...
  </kevm>

  requires 0 <Int N
   andBool #rangeUInt(256, S +Int ((N *Int (N +Int 1)) /Int 2))
   andBool #rangeUInt(256, N)
   andBool #rangeUInt(256, S)
   andBool GAS_AMT >=Int N *Int 178
   andBool CONDITION ==K bool2Word ( N:Int ==Int 0 )
   andBool PROGRAM ==K  #parseByteStack ( "0x608060405234801561001057600080fd5b50600436106101a95760003560e01c806366d9a9a0116100f9578063a118e10211610097578063d313940d11610071578063d313940d14610336578063d6a2ec7614610349578063e20c9f7114610388578063fa7626d41461039057600080fd5b8063a118e10214610303578063b5508aa914610316578063ba414fa61461031e57600080fd5b806385226c81116100d357806385226c81146102c0578063887e4fdb146102d55780638fe34aed146102e8578063916a17c6146102fb57600080fd5b806366d9a9a0146102855780636d5d39df1461029a5780637e8e23d0146102ad57600080fd5b80633e5e3c23116101665780634e94ce57116101405780634e94ce571461024457806351cdc192146102575780635a98a5c01461026a5780635de22f071461027257600080fd5b80633e5e3c231461022c5780633f7286f41461023457806340ca711a1461023c57600080fd5b806306ac1530146101ae5780630d472879146101c35780630de4eb16146101de578063181f88ec146101f15780631ed7831c1461020457806330476e2714610219575b600080fd5b6101c16101bc36600461180e565b61039d565b005b6101cb6103f6565b6040519081526020015b60405180910390f35b6101c16101ec366004611830565b610408565b6101c16101ff366004611830565b610466565b61020c610483565b6040516101d59190611849565b6101c1610227366004611830565b6104e5565b61020c610549565b61020c6105a9565b6101cb610609565b6101c1610252366004611830565b610615565b6101c16102653660046118ac565b6106b9565b6101cb610719565b6101c16102803660046118ac565b610725565b61028d61077b565b6040516101d5919061196a565b6101c16102a836600461180e565b61086a565b6101cb6102bb366004611830565b610875565b6102c861097d565b6040516101d59190611a75565b6101c16102e3366004611830565b610a4d565b6101c16102f63660046118ac565b610ae5565b61028d610b5f565b6101c161031136600461180e565b610c45565b6102c8610caf565b610326610d7f565b60405190151581526020016101d5565b6101c16103443660046118ac565b610eac565b6103707f885cb69240a935d632d79c317109709ecfa91a80626ff3989d68f67f5b1dd12d81565b6040516001600160a01b0390911681526020016101d5565b61020c610f26565b6007546103269060ff1681565b60006103a883610f86565b90506103bf8115806103ba5750600184115b610fd7565b6103f160028310806103d15750838310155b806103da575081155b806103ba57506103ea8385611aed565b1515610fd7565b505050565b60006104036103e8610875565b905090565b60006104138261104b565b905060006104218283611093565b905060008382111561043e576104378483611b17565b905061044b565b6104488383611b17565b90505b610460610459606486611b2e565b8210610fd7565b50505050565b61048061047282610f86565b61047b836110ce565b61111f565b50565b606060148054806020026020016040519081016040528092919081815260200182805480156104db57602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116104bd575b5050505050905090565b60006104f082610f86565b905080806104fe5750600282105b15610507575050565b60025b8281101561053a5761051c8184611aed565b60000361052857505050565b8061053281611b42565b91505061050a565b506105456000610fd7565b5050565b606060168054806020026020016040519081016040528092919081815260200182805480156104db576020028201919060005260206000209081546001600160a01b031681526001909101906020018083116104bd575050505050905090565b606060158054806020026020016040519081016040528092919081815260200182805480156104db576020028201919060005260206000209081546001600160a01b031681526001909101906020018083116104bd575050505050905090565b6000610403600a610875565b604051632631f2b160e11b815260648211156004820152737109709ecfa91a80626ff3989d68f67f5b1dd12d90634c63e5629060240160006040518083038186803b15801561066357600080fd5b505afa158015610677573d6000803e3d6000fd5b505050506000600282600161068c9190611b5b565b6106969084611b73565b6106a09190611b2e565b905060006106ad8361129c565b90506103f182826112ce565b60006106c4826113ad565b9050600160005b8351811080156106d85750815b1561070f578381815181106106ef576106ef611b92565b60200260200101518310159150808061070790611b42565b9150506106cb565b506103f181610fd7565b60006104036064610875565b60006107308261140c565b9050600160005b8351811080156107445750815b1561070f5783818151811061075b5761075b611b92565b60200260200101518310159150808061077390611b42565b915050610737565b60606019805480602002602001604051908101604052809291908181526020016000905b828210156108615760008481526020908190206040805180820182526002860290920180546001600160a01b0316835260018101805483518187028101870190945280845293949193858301939283018282801561084957602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b0319168152602001906004019060208260030104928301926001038202915080841161080b5790505b5050505050815250508152602001906001019061079f565b50505050905090565b60006103a88361146a565b604051632631f2b160e11b815266b81702e05c0b6f8211156004820152600090737109709ecfa91a80626ff3989d68f67f5b1dd12d90634c63e5629060240160006040518083038186803b1580156108cc57600080fd5b505afa1580156108e0573d6000803e3d6000fd5b5050604051636ea8fd5160e11b8152677ffffffffffff3d56004820152737109709ecfa91a80626ff3989d68f67f5b1dd12d925063dd51faa29150602401600060405180830381600087803b15801561093857600080fd5b505af115801561094c573d6000803e3d6000fd5b5050505060005b8215610977576109638382611b5b565b9050610970600184611b17565b9250610953565b92915050565b60606018805480602002602001604051908101604052809291908181526020016000905b828210156108615783829060005260206000200180546109c090611ba8565b80601f01602080910402602001604051908101604052809291908181526020018280546109ec90611ba8565b8015610a395780601f10610a0e57610100808354040283529160200191610a39565b820191906000526020600020905b815481529060010190602001808311610a1c57829003601f168201915b5050505050815260200190600101906109a1565b604051632631f2b160e11b815260648211156004820152737109709ecfa91a80626ff3989d68f67f5b1dd12d90634c63e5629060240160006040518083038186803b158015610a9b57600080fd5b505afa158015610aaf573d6000803e3d6000fd5b5050505060006002826001610ac49190611b5b565b610ace9084611b73565b610ad89190611b2e565b905060006106ad836114a1565b6000610af0826114cb565b90506001805b825181108015610b035750815b1561070f57838181518110610b1a57610b1a611b92565b602002602001015184600183610b309190611b17565b81518110610b4057610b40611b92565b6020026020010151111591508080610b5790611b42565b915050610af6565b6060601a805480602002602001604051908101604052809291908181526020016000905b828210156108615760008481526020908190206040805180820182526002860290920180546001600160a01b03168352600181018054835181870281018701909452808452939491938583019392830182828015610c2d57602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b03191681526020019060040190602082600301049283019260010382029150808411610bef5790505b50505050508152505081526020019060010190610b83565b6000610c50836114f7565b905082600003610c65576103f18160006112ce565b610c716103ba82610f86565b6000610c86610c81600186611b17565b6114f7565b90506104608184111580610c9a5750828410155b806103ba5750610ca984610f86565b15610fd7565b60606017805480602002602001604051908101604052809291908181526020016000905b82821015610861578382906000526020600020018054610cf290611ba8565b80601f0160208091040260200160405190810160405280929190818152602001828054610d1e90611ba8565b8015610d6b5780601f10610d4057610100808354040283529160200191610d6b565b820191906000526020600020905b815481529060010190602001808311610d4e57829003601f168201915b505050505081526020019060010190610cd3565b600754600090610100900460ff1615610da15750600754610100900460ff1690565b6000737109709ecfa91a80626ff3989d68f67f5b1dd12d3b15610ea75760408051737109709ecfa91a80626ff3989d68f67f5b1dd12d602082018190526519985a5b195960d21b82840152825180830384018152606083019093526000929091610e2f917f667f9d70ca411d70ead50d8d5c22070dafc36ad75f3dcf5e7237b22ade9aecc491608001611bdc565b60408051601f1981840301815290829052610e4991611c0d565b6000604051808303816000865af19150503d8060008114610e86576040519150601f19603f3d011682016040523d82523d6000602084013e610e8b565b606091505b5091505080806020019051810190610ea39190611c29565b9150505b919050565b6000610eb782611531565b90506001805b825181108015610eca5750815b1561070f57838181518110610ee157610ee1611b92565b602002602001015184600183610ef79190611b17565b81518110610f0757610f07611b92565b6020026020010151111591508080610f1e90611b42565b915050610ebd565b606060138054806020026020016040519081016040528092919081815260200182805480156104db576020028201919060005260206000209081546001600160a01b031681526001909101906020018083116104bd575050505050905090565b60006002821015610f9957506000919050565b60025b82811015610fce57610fae8184611aed565b15610fbc5750600092915050565b80610fc681611b42565b915050610f9c565b50600192915050565b80610480577f41304facd9323d75b11bcdd609cb38effffdb05710f7caf0e9b16c6d9d709f5060405161103b9060208082526017908201527f4572726f723a20417373657274696f6e204661696c6564000000000000000000604082015260600190565b60405180910390a1610480611553565b60008160000361105d57506000919050565b815b80915060028161106f858461165f565b6110799190611b5b565b6110839190611b2e565b905081810361105f575b50919050565b6000670de0b6b3a76400006110a9600282611b2e565b6110b38486611b73565b6110bd9190611b5b565b6110c79190611b2e565b9392505050565b600060028210156110e157506000919050565b60025b6110ef600284611b2e565b8111610fce576110ff8184611aed565b1561110d5750600092915050565b8061111781611b42565b9150506110e4565b80151582151514610545577f41304facd9323d75b11bcdd609cb38effffdb05710f7caf0e9b16c6d9d709f506040516111949060208082526022908201527f4572726f723a2061203d3d2062206e6f7420736174697366696564205b626f6f6040820152616c5d60f01b606082015260800190565b60405180910390a17f280f4446b28a1372417dda658d30b95b2992b12ac9c7f378535f29a97acf3583826111e5576040518060400160405280600581526020016466616c736560d81b815250611203565b604051806040016040528060048152602001637472756560e01b8152505b6040516112109190611c4b565b60405180910390a17f280f4446b28a1372417dda658d30b95b2992b12ac9c7f378535f29a97acf358381611261576040518060400160405280600581526020016466616c736560d81b81525061127f565b604051806040016040528060048152602001637472756560e01b8152505b60405161128c9190611c8f565b60405180910390a1610545611553565b600080805b838110156112c7576112b38183611b5b565b9150806112bf81611b42565b9150506112a1565b5092915050565b808214610545577f41304facd9323d75b11bcdd609cb38effffdb05710f7caf0e9b16c6d9d709f5060405161133f9060208082526022908201527f4572726f723a2061203d3d2062206e6f7420736174697366696564205b75696e604082015261745d60f01b606082015260800190565b60405180910390a17fb2de2fbe801a0df6c0cbddfd448ba3c41d48a040ca35c56c8196ef0fcae721a8826040516113769190611cb9565b60405180910390a17fb2de2fbe801a0df6c0cbddfd448ba3c41d48a040ca35c56c8196ef0fcae721a88160405161128c9190611cf1565b60008060015b83518110156112c757818482815181106113cf576113cf611b92565b602002602001015111156113fa578381815181106113ef576113ef611b92565b602002602001015191505b8061140481611b42565b9150506113b3565b600080805b83518110156112c7578184828151811061142d5761142d611b92565b602002602001015111156114585783818151811061144d5761144d611b92565b602002602001015191505b8061146281611b42565b915050611411565b600060025b82811015610fce576114818184611aed565b1561148f5750600092915050565b8061149981611b42565b91505061146f565b600080805b8381116112c7576114b78183611b5b565b9150806114c381611b42565b9150506114a6565b606060018251116114da575090565b6114f3826000600185516114ee9190611b17565b61167f565b5090565b6000805b8281101561108d578161150d81611b42565b92505061151982610f86565b1561152c578061152881611b42565b9150505b6114fb565b60606001825111611540575090565b6114f38260018085516114ee9190611b17565b737109709ecfa91a80626ff3989d68f67f5b1dd12d3b1561164e5760408051737109709ecfa91a80626ff3989d68f67f5b1dd12d602082018190526519985a5b195960d21b9282019290925260016060820152600091907f70ca10bbd0dbfd9020a9f4b13402c16cb120705e0d1c0aeab10fa353ae586fc49060800160408051601f19818403018152908290526115ed9291602001611bdc565b60408051601f198184030181529082905261160791611c0d565b6000604051808303816000865af19150503d8060008114611644576040519150601f19603f3d011682016040523d82523d6000602084013e611649565b606091505b505050505b6007805461ff001916610100179055565b60008161166d600282611b2e565b6110b3670de0b6b3a764000086611b73565b80821061168b57505050565b8181600085600261169c8585611b17565b6116a69190611b2e565b6116b09087611b5b565b815181106116c0576116c0611b92565b602002602001015190505b8183116117e0575b808684815181106116e6576116e6611b92565b6020026020010151101561170657826116fe81611b42565b9350506116d3565b85828151811061171857611718611b92565b60200260200101518110801561172e5750600082115b15611745578161173d81611d1b565b925050611706565b8183116117db5785828151811061175e5761175e611b92565b602002602001015186848151811061177857611778611b92565b602002602001015187858151811061179257611792611b92565b602002602001018885815181106117ab576117ab611b92565b602090810291909101019190915252826117c481611b42565b93505081156117db57816117d781611d1b565b9250505b6116cb565b818510156117f3576117f386868461167f565b838310156118065761180686848661167f565b505050505050565b6000806040838503121561182157600080fd5b50508035926020909101359150565b60006020828403121561184257600080fd5b5035919050565b6020808252825182820181905260009190848201906040850190845b8181101561188a5783516001600160a01b031683529284019291840191600101611865565b50909695505050505050565b634e487b7160e01b600052604160045260246000fd5b600060208083850312156118bf57600080fd5b823567ffffffffffffffff808211156118d757600080fd5b818501915085601f8301126118eb57600080fd5b8135818111156118fd576118fd611896565b8060051b604051601f19603f8301168101818110858211171561192257611922611896565b60405291825284820192508381018501918883111561194057600080fd5b938501935b8285101561195e57843584529385019392850192611945565b98975050505050505050565b60006020808301818452808551808352604092508286019150828160051b8701018488016000805b84811015611a0e57898403603f19018652825180516001600160a01b03168552880151888501889052805188860181905290890190839060608701905b808310156119f95783516001600160e01b0319168252928b019260019290920191908b01906119cf565b50978a01979550505091870191600101611992565b50919998505050505050505050565b60005b83811015611a38578181015183820152602001611a20565b838111156104605750506000910152565b60008151808452611a61816020860160208601611a1d565b601f01601f19169290920160200192915050565b6000602080830181845280855180835260408601915060408160051b870101925083870160005b82811015611aca57603f19888603018452611ab8858351611a49565b94509285019290850190600101611a9c565b5092979650505050505050565b634e487b7160e01b600052601260045260246000fd5b600082611afc57611afc611ad7565b500690565b634e487b7160e01b600052601160045260246000fd5b600082821015611b2957611b29611b01565b500390565b600082611b3d57611b3d611ad7565b500490565b600060018201611b5457611b54611b01565b5060010190565b60008219821115611b6e57611b6e611b01565b500190565b6000816000190483118215151615611b8d57611b8d611b01565b500290565b634e487b7160e01b600052603260045260246000fd5b600181811c90821680611bbc57607f821691505b60208210810361108d57634e487b7160e01b600052602260045260246000fd5b6001600160e01b0319831681528151600090611bff816004850160208701611a1d565b919091016004019392505050565b60008251611c1f818460208701611a1d565b9190910192915050565b600060208284031215611c3b57600080fd5b815180151581146110c757600080fd5b604081526000611c7560408301600a8152690808080808081319599d60b21b602082015260400190565b8281036020840152611c878185611a49565b949350505050565b604081526000611c7560408301600a8152690808080808149a59da1d60b21b602082015260400190565b604081526000611ce360408301600a8152690808080808081319599d60b21b602082015260400190565b905082602083015292915050565b604081526000611ce360408301600a8152690808080808149a59da1d60b21b602082015260400190565b600081611d2a57611d2a611b01565b50600019019056fea2646970667358221220343a049bc0ee1895c580ac581edbbf9eb3ccab412bbe2ed613951d352bf853e464736f6c634300080d0033" )
   andBool JUMPDESTS ==K #computeValidJumpDests(PROGRAM)
  [priority(40)]

endmodule
