requires "../contracts.k"

module SUM-TO-N-INVARIANT

  imports S2KtestZModLoopsTest-CONTRACT

  rule N xorInt maxUInt256 => maxUInt256 -Int N 
  requires #rangeUInt(256, N)
  [simplification]

  rule [foundry-sum-to-n-loop-invariant]:
  <kevm>
    <k>
      ((JUMPI 2951 CONDITION) => JUMP 2951)
      ~> #pc [ JUMPI ]
      ~> #execute
      ...
    </k>
    <mode>
      NORMAL
    </mode>
    <schedule>
      SHANGHAI
    </schedule>
    <ethereum>
      <evm>
        <callState>
          <program>
            PROGRAM
          </program>
          <jumpDests>
            JUMPDESTS
          </jumpDests>
          <wordStack>
              (S => (S +Int ((N *Int (N +Int 1)) /Int 2)))
            : 0 
            : (N => 0)
            : 497 
            : 2123244496 
            : .WordStack
          </wordStack>
          <pc>
            2921
          </pc>
          <gas>
            GAS_AMT:Int => GAS_AMT -Int (N *Int 178)
          </gas>
          ...
        </callState>
        ...
      </evm>
      ...
    </ethereum>
    ...
  </kevm>

  requires 0 <Int N
   andBool #rangeUInt(256, S +Int ((N *Int (N +Int 1)) /Int 2))
   andBool #rangeUInt(256, N)
   andBool #rangeUInt(256, S)
   andBool GAS_AMT >=Int N *Int 178
   andBool CONDITION ==K bool2Word ( N:Int ==Int 0 )
   andBool PROGRAM ==K #parseByteStack ( "0x608060405234801561001057600080fd5b50600436106101cf5760003560e01c806366d9a9a011610104578063a118e102116100a2578063d313940d11610071578063d313940d14610386578063d6a2ec7614610399578063e20c9f71146103d8578063fa7626d4146103e057600080fd5b8063a118e1021461034b578063b0464fdc1461035e578063b5508aa914610366578063ba414fa61461036e57600080fd5b806385226c81116100de57806385226c81146102fb578063887e4fdb146103105780638fe34aed14610323578063916a17c61461033657600080fd5b806366d9a9a0146102c05780636d5d39df146102d55780637e8e23d0146102e857600080fd5b80633e5e3c23116101715780634e94ce571161014b5780634e94ce571461027f57806351cdc192146102925780635a98a5c0146102a55780635de22f07146102ad57600080fd5b80633e5e3c23146102675780633f7286f41461026f57806340ca711a1461027757600080fd5b8063181f88ec116101ad578063181f88ec146102175780631ed7831c1461022a5780632ade38801461023f57806330476e271461025457600080fd5b806306ac1530146101d45780630d472879146101e95780630de4eb1614610204575b600080fd5b6101e76101e23660046117ae565b6103ed565b005b6101f1610446565b6040519081526020015b60405180910390f35b6101e76102123660046117d0565b610458565b6101e76102253660046117d0565b6104b6565b6102326104d3565b6040516101fb91906117e9565b610247610535565b6040516101fb9190611883565b6101e76102623660046117d0565b610677565b6102326106db565b61023261073b565b6101f161079b565b6101e761028d3660046117d0565b6107a7565b6101e76102a0366004611959565b61084b565b6101f16108ab565b6101e76102bb366004611959565b6108b7565b6102c861090d565b6040516101fb9190611a5c565b6101e76102e33660046117ae565b610a7a565b6101f16102f63660046117d0565b610a85565b610303610b8d565b6040516101fb9190611ae1565b6101e761031e3660046117d0565b610c5d565b6101e7610331366004611959565b610cf5565b61033e610d6f565b6040516101fb9190611b43565b6101e76103593660046117ae565b610e55565b61033e610ebf565b610303610fa5565b610376611075565b60405190151581526020016101fb565b6101e7610394366004611959565b611119565b6103c07f885cb69240a935d632d79c317109709ecfa91a80626ff3989d68f67f5b1dd12d81565b6040516001600160a01b0390911681526020016101fb565b610232611193565b601f546103769060ff1681565b60006103f8836111f3565b905061040f81158061040a5750600184115b611244565b61044160028310806104215750838310155b8061042a575081155b8061040a575061043a8385611bc8565b1515611244565b505050565b60006104536103e8610a85565b905090565b6000610463826112ab565b9050600061047182836112f3565b905060008382111561048e576104878483611bf2565b905061049b565b6104988383611bf2565b90505b6104b06104a9606486611c09565b8210611244565b50505050565b6104d06104c2826111f3565b6104cb8361132e565b61137f565b50565b6060601680548060200260200160405190810160405280929190818152602001828054801561052b57602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831161050d575b5050505050905090565b6060601e805480602002602001604051908101604052809291908181526020016000905b8282101561066e57600084815260208082206040805180820182526002870290920180546001600160a01b03168352600181018054835181870281018701909452808452939591948681019491929084015b828210156106575783829060005260206000200180546105ca90611c1d565b80601f01602080910402602001604051908101604052809291908181526020018280546105f690611c1d565b80156106435780601f1061061857610100808354040283529160200191610643565b820191906000526020600020905b81548152906001019060200180831161062657829003601f168201915b5050505050815260200190600101906105ab565b505050508152505081526020019060010190610559565b50505050905090565b6000610682826111f3565b905080806106905750600282105b15610699575050565b60025b828110156106cc576106ae8184611bc8565b6000036106ba57505050565b806106c481611c51565b91505061069c565b506106d76000611244565b5050565b6060601880548060200260200160405190810160405280929190818152602001828054801561052b576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831161050d575050505050905090565b6060601780548060200260200160405190810160405280929190818152602001828054801561052b576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831161050d575050505050905090565b6000610453600a610a85565b604051632631f2b160e11b815260648211156004820152737109709ecfa91a80626ff3989d68f67f5b1dd12d90634c63e5629060240160006040518083038186803b1580156107f557600080fd5b505afa158015610809573d6000803e3d6000fd5b505050506000600282600161081e9190611c6a565b6108289084611c82565b6108329190611c09565b9050600061083f836113f0565b90506104418282611422565b600061085682611461565b9050600160005b83518110801561086a5750815b156108a15783818151811061088157610881611ca1565b60200260200101518310159150808061089990611c51565b91505061085d565b5061044181611244565b60006104536064610a85565b60006108c2826114c0565b9050600160005b8351811080156108d65750815b156108a1578381815181106108ed576108ed611ca1565b60200260200101518310159150808061090590611c51565b9150506108c9565b6060601b805480602002602001604051908101604052809291908181526020016000905b8282101561066e578382906000526020600020906002020160405180604001604052908160008201805461096490611c1d565b80601f016020809104026020016040519081016040528092919081815260200182805461099090611c1d565b80156109dd5780601f106109b2576101008083540402835291602001916109dd565b820191906000526020600020905b8154815290600101906020018083116109c057829003601f168201915b5050505050815260200160018201805480602002602001604051908101604052809291908181526020018280548015610a6257602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b03191681526020019060040190602082600301049283019260010382029150808411610a245790505b50505050508152505081526020019060010190610931565b60006103f88361151e565b604051632631f2b160e11b815266b81702e05c0b6f8211156004820152600090737109709ecfa91a80626ff3989d68f67f5b1dd12d90634c63e5629060240160006040518083038186803b158015610adc57600080fd5b505afa158015610af0573d6000803e3d6000fd5b5050604051636ea8fd5160e11b8152677ffffffffffff3d56004820152737109709ecfa91a80626ff3989d68f67f5b1dd12d925063dd51faa29150602401600060405180830381600087803b158015610b4857600080fd5b505af1158015610b5c573d6000803e3d6000fd5b5050505060005b8215610b8757610b738382611c6a565b9050610b80600184611bf2565b9250610b63565b92915050565b6060601a805480602002602001604051908101604052809291908181526020016000905b8282101561066e578382906000526020600020018054610bd090611c1d565b80601f0160208091040260200160405190810160405280929190818152602001828054610bfc90611c1d565b8015610c495780601f10610c1e57610100808354040283529160200191610c49565b820191906000526020600020905b815481529060010190602001808311610c2c57829003601f168201915b505050505081526020019060010190610bb1565b604051632631f2b160e11b815260648211156004820152737109709ecfa91a80626ff3989d68f67f5b1dd12d90634c63e5629060240160006040518083038186803b158015610cab57600080fd5b505afa158015610cbf573d6000803e3d6000fd5b5050505060006002826001610cd49190611c6a565b610cde9084611c82565b610ce89190611c09565b9050600061083f83611555565b6000610d008261157f565b90506001805b825181108015610d135750815b156108a157838181518110610d2a57610d2a611ca1565b602002602001015184600183610d409190611bf2565b81518110610d5057610d50611ca1565b6020026020010151111591508080610d6790611c51565b915050610d06565b6060601d805480602002602001604051908101604052809291908181526020016000905b8282101561066e5760008481526020908190206040805180820182526002860290920180546001600160a01b03168352600181018054835181870281018701909452808452939491938583019392830182828015610e3d57602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b03191681526020019060040190602082600301049283019260010382029150808411610dff5790505b50505050508152505081526020019060010190610d93565b6000610e60836115ab565b905082600003610e7557610441816000611422565b610e8161040a826111f3565b6000610e96610e91600186611bf2565b6115ab565b90506104b08184111580610eaa5750828410155b8061040a5750610eb9846111f3565b15611244565b6060601c805480602002602001604051908101604052809291908181526020016000905b8282101561066e5760008481526020908190206040805180820182526002860290920180546001600160a01b03168352600181018054835181870281018701909452808452939491938583019392830182828015610f8d57602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b03191681526020019060040190602082600301049283019260010382029150808411610f4f5790505b50505050508152505081526020019060010190610ee3565b60606019805480602002602001604051908101604052809291908181526020016000905b8282101561066e578382906000526020600020018054610fe890611c1d565b80601f016020809104026020016040519081016040528092919081815260200182805461101490611c1d565b80156110615780601f1061103657610100808354040283529160200191611061565b820191906000526020600020905b81548152906001019060200180831161104457829003601f168201915b505050505081526020019060010190610fc9565b60085460009060ff161561108d575060085460ff1690565b604051630667f9d760e41b8152737109709ecfa91a80626ff3989d68f67f5b1dd12d600482018190526519985a5b195960d21b602483015260009163667f9d7090604401602060405180830381865afa1580156110ee573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906111129190611cb7565b1415905090565b6000611124826115e5565b90506001805b8251811080156111375750815b156108a15783818151811061114e5761114e611ca1565b6020026020010151846001836111649190611bf2565b8151811061117457611174611ca1565b602002602001015111159150808061118b90611c51565b91505061112a565b6060601580548060200260200160405190810160405280929190818152602001828054801561052b576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831161050d575050505050905090565b6000600282101561120657506000919050565b60025b8281101561123b5761121b8184611bc8565b156112295750600092915050565b8061123381611c51565b915050611209565b50600192915050565b604051630c9fd58160e01b81528115156004820152737109709ecfa91a80626ff3989d68f67f5b1dd12d90630c9fd5819060240160006040518083038186803b15801561129057600080fd5b505afa1580156112a4573d6000803e3d6000fd5b5050505050565b6000816000036112bd57506000919050565b815b8091506002816112cf8584611607565b6112d99190611c6a565b6112e39190611c09565b90508181036112bf575b50919050565b6000670de0b6b3a7640000611309600282611c09565b6113138486611c82565b61131d9190611c6a565b6113279190611c09565b9392505050565b6000600282101561134157506000919050565b60025b61134f600284611c09565b811161123b5761135f8184611bc8565b1561136d5750600092915050565b8061137781611c51565b915050611344565b60405163f7fe347760e01b815282151560048201528115156024820152737109709ecfa91a80626ff3989d68f67f5b1dd12d9063f7fe3477906044015b60006040518083038186803b1580156113d457600080fd5b505afa1580156113e8573d6000803e3d6000fd5b505050505050565b600080805b8381101561141b576114078183611c6a565b91508061141381611c51565b9150506113f5565b5092915050565b60405163260a5b1560e21b81526004810183905260248101829052737109709ecfa91a80626ff3989d68f67f5b1dd12d906398296c54906044016113bc565b60008060015b835181101561141b578184828151811061148357611483611ca1565b602002602001015111156114ae578381815181106114a3576114a3611ca1565b602002602001015191505b806114b881611c51565b915050611467565b600080805b835181101561141b57818482815181106114e1576114e1611ca1565b6020026020010151111561150c5783818151811061150157611501611ca1565b602002602001015191505b8061151681611c51565b9150506114c5565b600060025b8281101561123b576115358184611bc8565b156115435750600092915050565b8061154d81611c51565b915050611523565b600080805b83811161141b5761156b8183611c6a565b91508061157781611c51565b91505061155a565b6060600182511161158e575090565b6115a7826000600185516115a29190611bf2565b611627565b5090565b6000805b828110156112ed57816115c181611c51565b9250506115cd826111f3565b156115e057806115dc81611c51565b9150505b6115af565b606060018251116115f4575090565b6115a78260018085516115a29190611bf2565b600081611615600282611c09565b611313670de0b6b3a764000086611c82565b80821061163357505050565b818160008560026116448585611bf2565b61164e9190611c09565b6116589087611c6a565b8151811061166857611668611ca1565b602002602001015190505b818311611788575b8086848151811061168e5761168e611ca1565b602002602001015110156116ae57826116a681611c51565b93505061167b565b8582815181106116c0576116c0611ca1565b6020026020010151811080156116d65750600082115b156116ed57816116e581611cd0565b9250506116ae565b8183116117835785828151811061170657611706611ca1565b602002602001015186848151811061172057611720611ca1565b602002602001015187858151811061173a5761173a611ca1565b6020026020010188858151811061175357611753611ca1565b6020908102919091010191909152528261176c81611c51565b9350508115611783578161177f81611cd0565b9250505b611673565b8185101561179b5761179b868684611627565b838310156113e8576113e8868486611627565b600080604083850312156117c157600080fd5b50508035926020909101359150565b6000602082840312156117e257600080fd5b5035919050565b6020808252825182820181905260009190848201906040850190845b8181101561182a5783516001600160a01b031683529284019291840191600101611805565b50909695505050505050565b6000815180845260005b8181101561185c57602081850181015186830182015201611840565b8181111561186e576000602083870101525b50601f01601f19169290920160200192915050565b602080825282518282018190526000919060409081850190600581811b8701840188860187805b8581101561193357603f198b8503018752825180516001600160a01b031685528901518985018990528051898601819052908a0190606081881b870181019190870190855b8181101561191d57605f1989850301835261190b848651611836565b948e01949350918d01916001016118ef565b505050978a0197945050918801916001016118aa565b50919a9950505050505050505050565b634e487b7160e01b600052604160045260246000fd5b6000602080838503121561196c57600080fd5b823567ffffffffffffffff8082111561198457600080fd5b818501915085601f83011261199857600080fd5b8135818111156119aa576119aa611943565b8060051b604051601f19603f830116810181811085821117156119cf576119cf611943565b6040529182528482019250838101850191888311156119ed57600080fd5b938501935b82851015611a0b578435845293850193928501926119f2565b98975050505050505050565b600081518084526020808501945080840160005b83811015611a515781516001600160e01b03191687529582019590820190600101611a2b565b509495945050505050565b60006020808301818452808551808352604092508286019150828160051b87010184880160005b83811015611ad357888303603f1901855281518051878552611aa788860182611836565b91890151858303868b0152919050611abf8183611a17565b968901969450505090860190600101611a83565b509098975050505050505050565b6000602080830181845280855180835260408601915060408160051b870101925083870160005b82811015611b3657603f19888603018452611b24858351611836565b94509285019290850190600101611b08565b5092979650505050505050565b60006020808301818452808551808352604092508286019150828160051b87010184880160005b83811015611ad357888303603f19018552815180516001600160a01b03168452870151878401879052611b9f87850182611a17565b9588019593505090860190600101611b6a565b634e487b7160e01b600052601260045260246000fd5b600082611bd757611bd7611bb2565b500690565b634e487b7160e01b600052601160045260246000fd5b600082821015611c0457611c04611bdc565b500390565b600082611c1857611c18611bb2565b500490565b600181811c90821680611c3157607f821691505b6020821081036112ed57634e487b7160e01b600052602260045260246000fd5b600060018201611c6357611c63611bdc565b5060010190565b60008219821115611c7d57611c7d611bdc565b500190565b6000816000190483118215151615611c9c57611c9c611bdc565b500290565b634e487b7160e01b600052603260045260246000fd5b600060208284031215611cc957600080fd5b5051919050565b600081611cdf57611cdf611bdc565b50600019019056fea164736f6c634300080d000a" )
   andBool JUMPDESTS ==K #computeValidJumpDests(PROGRAM)
  [priority(40)]

endmodule
